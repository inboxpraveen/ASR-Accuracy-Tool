{% extends "base.html" %}

{% block content %}
<div class="container-fluid">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="app-header">
                <h1 class="mb-2">ASR Accuracy Tool</h1>
                <p class="text-muted mb-0">Professional transcription review and correction platform</p>
            </div>
        </div>
    </div>

    <!-- Job Status Banner (Hidden by default) -->
    <div id="jobStatusBanner" class="row mb-3" style="display: none;">
        <div class="col-12">
            <div class="alert alert-info d-flex align-items-center justify-content-between mb-0">
                <div class="d-flex align-items-center gap-3 flex-grow-1">
                    <div class="spinner-border spinner-border-sm text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <div class="flex-grow-1">
                        <div class="fw-semibold" id="jobStatusText">Processing...</div>
                        <div class="progress mt-2" style="height: 8px;">
                            <div class="progress-bar progress-bar-striped progress-bar-animated" 
                                 id="jobProgressBar" 
                                 role="progressbar" 
                                 style="width: 0%"></div>
                        </div>
                        <small class="text-muted" id="jobProgressText">0 / 0 items processed</small>
                    </div>
                </div>
                <button class="btn btn-sm btn-outline-secondary" id="dismissJobStatus">Dismiss</button>
            </div>
        </div>
    </div>

    <!-- Main Features Section -->
    <div class="row g-4 mb-4">
        <!-- Feature 1: Manual Review -->
        <div class="col-lg-6">
            <div class="feature-card primary-feature">
                <div class="feature-header">
                    <div class="feature-icon primary">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" viewBox="0 0 16 16">
                            <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/>
                            <path d="M10.97 4.97a.235.235 0 0 0-.02.022L7.477 9.417 5.384 7.323a.75.75 0 0 0-1.06 1.06L6.97 11.03a.75.75 0 0 0 1.079-.02l3.992-4.99a.75.75 0 0 0-1.071-1.05z"/>
                        </svg>
                    </div>
                    <div>
                        <h3 class="feature-title">Review & Correct</h3>
                        <p class="feature-subtitle">Load pre-chunked audio with existing transcripts</p>
                    </div>
                    <span class="badge bg-primary">Primary</span>
                </div>
                
                <form id="manual-load-form" class="feature-form">
                    <div class="form-group">
                        <label class="form-label">Chunked Audio Folder</label>
                        <div class="input-group">
                            <input type="text" class="form-control" id="chunkFolder" 
                                   placeholder="Select folder containing audio chunks..." required>
                            <button class="btn btn-outline-secondary" type="button" id="browseChunk">
                                Browse
                            </button>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Excel File with Transcripts</label>
                        <div class="input-group">
                            <input type="text" class="form-control" id="excelPath" 
                                   placeholder="Select Excel file..." required>
                            <button class="btn btn-outline-secondary" type="button" id="browseExcel">
                                Browse
                            </button>
                        </div>
                        <small class="form-text text-muted">
                            Excel must contain: <code>filename</code>, <code>transcription</code> (optional: <code>correct_transcripts</code>)
                        </small>
                    </div>
                    
                    <button type="submit" class="btn btn-primary w-100">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="me-2" viewBox="0 0 16 16">
                            <path d="M11 5a3 3 0 1 1-6 0 3 3 0 0 1 6 0ZM8 7a2 2 0 1 0 0-4 2 2 0 0 0 0 4Zm.256 7a4.474 4.474 0 0 1-.229-1.004H3c.001-.246.154-.986.832-1.664C4.484 10.68 5.711 10 8 10c.26 0 .507.009.74.025.226-.341.496-.65.804-.918C9.077 9.038 8.564 9 8 9c-5 0-6 3-6 4s1 1 1 1h5.256Z"/>
                            <path d="M16 12.5a3.5 3.5 0 1 1-7 0 3.5 3.5 0 0 1 7 0Zm-1.993-1.679a.5.5 0 0 0-.686.172l-1.17 1.95-.547-.547a.5.5 0 0 0-.708.708l.774.773a.75.75 0 0 0 1.174-.144l1.335-2.226a.5.5 0 0 0-.172-.686Z"/>
                        </svg>
                        Load for Review
                    </button>
                </form>
                
                <div class="feature-stats">
                    <div class="stat-item">
                        <div class="stat-icon">üìù</div>
                        <div>
                            <div class="stat-label">Total Records</div>
                            <div class="stat-value" id="totalRecords">0</div>
                        </div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-icon">‚úÖ</div>
                        <div>
                            <div class="stat-label">Corrected</div>
                            <div class="stat-value" id="correctedRecords">0</div>
                        </div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-icon">üîí</div>
                        <div>
                            <div class="stat-label">Locked</div>
                            <div class="stat-value" id="lockedRecords">0</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Feature 2: Auto Transcribe -->
        <div class="col-lg-6">
            <div class="feature-card secondary-feature">
                <div class="feature-header">
                    <div class="feature-icon secondary">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" viewBox="0 0 16 16">
                            <path d="M5 4a.5.5 0 0 0 0 1h6a.5.5 0 0 0 0-1H5zm-.5 2.5A.5.5 0 0 1 5 6h6a.5.5 0 0 1 0 1H5a.5.5 0 0 1-.5-.5zM5 8a.5.5 0 0 0 0 1h6a.5.5 0 0 0 0-1H5zm0 2a.5.5 0 0 0 0 1h3a.5.5 0 0 0 0-1H5z"/>
                            <path d="M2 2a2 2 0 0 1 2-2h8a2 2 0 0 1 2 2v12a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V2zm10-1H4a1 1 0 0 0-1 1v12a1 1 0 0 0 1 1h8a1 1 0 0 0 1-1V2a1 1 0 0 0-1-1z"/>
                        </svg>
                    </div>
                    <div>
                        <h3 class="feature-title">Auto-Transcribe</h3>
                        <p class="feature-subtitle">Process audio folder with AI model</p>
                    </div>
                    <span class="badge bg-secondary">Secondary</span>
                </div>
                
                <form id="start-transcribe-form" class="feature-form">
                    <div class="form-group">
                        <label class="form-label">Audio Folder</label>
                        <div class="input-group">
                            <input type="text" class="form-control" id="folderPath" 
                                   placeholder="Select folder with audio files..." required>
                            <button class="btn btn-outline-secondary" type="button" id="browseAudio">
                                Browse
                            </button>
                        </div>
                        <small class="form-text text-muted">
                            Non-audio files will be automatically skipped
                        </small>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Whisper Model</label>
                        <select class="form-select" id="modelName">
                            <option value="{{ default_model }}">{{ default_model }} (Default)</option>
                            <option value="openai/whisper-tiny">openai/whisper-tiny (Fast)</option>
                            <option value="openai/whisper-base">openai/whisper-base (Balanced)</option>
                            <option value="openai/whisper-small">openai/whisper-small (Accurate)</option>
                        </select>
                    </div>
                    
                    <button type="submit" class="btn btn-outline-primary w-100">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="me-2" viewBox="0 0 16 16">
                            <path d="M11.596 8.697l-6.363 3.692c-.54.313-1.233-.066-1.233-.697V4.308c0-.63.692-1.01 1.233-.696l6.363 3.692a.802.802 0 0 1 0 1.393z"/>
                        </svg>
                        Start Transcription
                    </button>
                </form>
                
                <div class="feature-info">
                    <div class="info-item">
                        <strong>Auto-chunking:</strong> Large files are split into 30s segments
                    </div>
                    <div class="info-item">
                        <strong>Processing:</strong> Runs in background, tracks progress automatically
                    </div>
                    <div class="info-item">
                        <strong>Queue:</strong> Only one transcription job can run at a time
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Export Section -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="export-card">
                <div class="d-flex align-items-center justify-content-between">
                    <div>
                        <h5 class="mb-1">Export Results</h5>
                        <p class="text-muted mb-0 small">Download corrected transcriptions anytime</p>
                    </div>
                    <div class="btn-group">
                        <button class="btn btn-outline-primary" id="exportXlsx">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="me-1" viewBox="0 0 16 16">
                                <path d="M5.884 6.68a.5.5 0 1 0-.768.64L7.349 10l-2.233 2.68a.5.5 0 0 0 .768.64L8 10.781l2.116 2.54a.5.5 0 0 0 .768-.641L8.651 10l2.233-2.68a.5.5 0 0 0-.768-.64L8 9.219l-2.116-2.54z"/>
                                <path d="M14 14V4.5L9.5 0H4a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2zM9.5 3A1.5 1.5 0 0 0 11 4.5h2V14a1 1 0 0 1-1 1H4a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1h5.5v2z"/>
                            </svg>
                            Export XLSX
                        </button>
                        <button class="btn btn-outline-primary" id="exportCsv">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="me-1" viewBox="0 0 16 16">
                                <path d="M14 4.5V14a2 2 0 0 1-2 2h-1v-1h1a1 1 0 0 0 1-1V4.5h-2A1.5 1.5 0 0 1 9.5 3V1H4a1 1 0 0 0-1 1v9H2V2a2 2 0 0 1 2-2h5.5L14 4.5z"/>
                                <path d="M3.517 14.841a1.13 1.13 0 0 0 .401.823c.13.108.289.192.478.252.19.061.411.091.665.091.338 0 .624-.053.859-.158.236-.105.416-.252.539-.44.125-.189.187-.408.187-.656 0-.224-.045-.41-.134-.56a1.001 1.001 0 0 0-.375-.357 2.027 2.027 0 0 0-.566-.21l-.621-.144a.97.97 0 0 1-.404-.176.37.37 0 0 1-.144-.299c0-.156.062-.284.185-.384.125-.101.296-.152.512-.152.143 0 .266.023.37.068a.624.624 0 0 1 .246.181.56.56 0 0 1 .12.258h.75a1.092 1.092 0 0 0-.2-.566 1.21 1.21 0 0 0-.5-.41 1.813 1.813 0 0 0-.78-.152c-.293 0-.551.05-.776.15-.225.099-.4.24-.527.421-.127.182-.19.395-.19.639 0 .201.04.376.122.524.082.149.2.27.352.367.152.095.332.167.539.213l.618.144c.207.049.361.113.463.193a.387.387 0 0 1 .152.326.505.505 0 0 1-.085.29.559.559 0 0 1-.255.193c-.111.047-.249.07-.413.07-.117 0-.223-.013-.32-.04a.838.838 0 0 1-.248-.115.578.578 0 0 1-.255-.384h-.765ZM.806 13.693c0-.248.034-.46.102-.633a.868.868 0 0 1 .302-.399.814.814 0 0 1 .475-.137c.15 0 .283.032.398.097a.7.7 0 0 1 .272.26.85.85 0 0 1 .12.381h.765v-.072a1.33 1.33 0 0 0-.466-.964 1.441 1.441 0 0 0-.489-.272 1.838 1.838 0 0 0-.606-.097c-.356 0-.66.074-.911.223-.25.148-.44.359-.572.632-.13.274-.196.6-.196.979v.498c0 .379.064.704.193.976.131.271.322.48.572.626.25.145.554.217.914.217.293 0 .554-.055.785-.164.23-.11.414-.26.55-.454a1.27 1.27 0 0 0 .226-.674v-.076h-.764a.799.799 0 0 1-.118.363.7.7 0 0 1-.272.25.874.874 0 0 1-.401.087.845.845 0 0 1-.478-.132.833.833 0 0 1-.299-.392 1.699 1.699 0 0 1-.102-.627v-.495Zm8.239 2.238h-.953l-1.338-3.999h.917l.896 3.138h.038l.888-3.138h.879l-1.327 3.999Z"/>
                            </svg>
                            Export CSV
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Transcriptions Table -->
    <div class="row">
        <div class="col-12">
            <div class="transcriptions-card">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <div>
                        <h5 class="mb-1">Transcriptions</h5>
                        <small class="text-muted">Edit, lock, and track your corrections</small>
                    </div>
                    <div class="d-flex gap-2 align-items-center">
                        <button class="btn btn-sm btn-outline-secondary" id="refreshRecords">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                                <path fill-rule="evenodd" d="M8 3a5 5 0 1 0 4.546 2.914.5.5 0 0 1 .908-.417A6 6 0 1 1 8 2v1z"/>
                                <path d="M8 4.466V.534a.25.25 0 0 1 .41-.192l2.36 1.966c.12.1.12.284 0 .384L8.41 4.658A.25.25 0 0 1 8 4.466z"/>
                            </svg>
                            Refresh
                        </button>
                        <span class="badge bg-success" id="autoUpdateStatus">Auto-update ON</span>
                    </div>
                </div>
                
                <div class="table-responsive">
                    <table class="table align-middle" id="transcriptionTable">
                        <thead>
                            <tr>
                                <th style="width: 50px;">#</th>
                                <th style="width: 180px;">Audio</th>
                                <th style="width: 30%;">Original Transcript</th>
                                <th style="width: 35%;">Corrected Transcript</th>
                                <th style="width: 180px;">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in data %}
                            <tr data-id="{{ item.id }}" data-filename="{{ item.filename }}" class="{% if item.locked %}locked-row{% endif %}">
                                <td class="text-muted">{{ loop.index }}</td>
                                <td>
                                    <audio controls preload="none" class="w-100">
                                        <source src="{{ url_for('api.serve_segment', filename=item.filename.split('/')[-1]) }}" type="audio/wav">
                                    </audio>
                                </td>
                                <td class="original-text">{{ item.transcription }}</td>
                                <td contenteditable="{% if item.locked %}false{% else %}true{% endif %}" 
                                    class="editable {% if item.locked %}locked{% endif %}" 
                                    data-original="{{ item.correct_transcripts }}">{{ item.correct_transcripts }}</td>
                                <td>
                                    <div class="action-buttons">
                                        <button class="btn btn-sm btn-success save-btn" {% if item.locked %}disabled{% endif %}>
                                            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" viewBox="0 0 16 16">
                                                <path d="M10.97 4.97a.75.75 0 0 1 1.07 1.05l-3.99 4.99a.75.75 0 0 1-1.08.02L4.324 8.384a.75.75 0 1 1 1.06-1.06l2.094 2.093 3.473-4.425a.267.267 0 0 1 .02-.022z"/>
                                            </svg>
                                            Save
                                        </button>
                                        {% if item.locked %}
                                        <button class="btn btn-sm btn-outline-warning unlock-btn">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" viewBox="0 0 16 16">
                                                <path d="M11 1a2 2 0 0 0-2 2v4a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V9a2 2 0 0 1 2-2h5V3a3 3 0 0 1 6 0v4a.5.5 0 0 1-1 0V3a2 2 0 0 0-2-2z"/>
                                            </svg>
                                            Unlock
                                        </button>
                                        {% else %}
                                        <button class="btn btn-sm btn-outline-secondary lock-btn">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" viewBox="0 0 16 16">
                                                <path d="M8 1a2 2 0 0 1 2 2v4H6V3a2 2 0 0 1 2-2zm3 6V3a3 3 0 0 0-6 0v4a2 2 0 0 0-2 2v5a2 2 0 0 0 2 2h6a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2z"/>
                                            </svg>
                                            Lock
                                        </button>
                                        {% endif %}
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}
